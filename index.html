<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 여행 앨범 메이커</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            scroll-behavior: smooth;
        }
        .drag-area-highlight {
            border-color: #ffffff;
            transform: scale(1.02);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .loader {
            border-top-color: #38bdf8;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen sm:p-4">

    <div class="container mx-auto w-full h-screen sm:h-auto sm:min-h-[90vh] max-w-6xl bg-white sm:rounded-2xl sm:shadow-2xl flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="p-4 sm:p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50 flex-shrink-0 z-10">
            <div class="flex items-center space-x-3">
                 <button id="menu-toggle-button" class="hidden md:hidden p-2 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <svg class="w-6 h-6 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                 </button>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <svg class="w-7 h-7 sm:w-8 sm:h-8 text-sky-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/><path d="m15 12-3 3 3 3"/></svg>
                    <h1 class="text-xl sm:text-2xl font-bold text-slate-700">AI 여행 앨범 메이커</h1>
                </div>
            </div>
            <button id="export-button" class="hidden bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-3 sm:px-5 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                <span class="hidden sm:inline">앨범으로 내보내기</span>
            </button>
        </header>

        <!-- Main Content -->
        <div class="flex-grow flex relative overflow-hidden">
            <!-- Sidebar for navigation -->
            <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden"></div>
            <aside id="sidebar" class="hidden fixed inset-y-0 left-0 z-40 w-72 bg-slate-50 border-r border-slate-200 overflow-y-auto custom-scrollbar transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:w-64 md:translate-x-0 md:flex-shrink-0 flex flex-col p-6">
                <div class="flex-grow">
                    <h3 class="text-lg font-bold mb-4 text-slate-600">카테고리 필터</h3>
                    <nav id="category-nav" class="space-y-2">
                        <!-- Dynamic category links -->
                    </nav>
                    <div class="mt-8 pt-6 border-t border-slate-200">
                         <h3 class="text-lg font-bold mb-4 text-slate-600">여행 일정</h3>
                         <nav id="date-nav" class="space-y-2">
                            <!-- Dynamic date links -->
                         </nav>
                         <button id="filter-reset-button" class="hidden w-full text-center mt-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-3 rounded-lg transition-all">필터 초기화</button>
                    </div>
                </div>
                 <div class="flex-shrink-0 pt-6 mt-6 border-t border-slate-200">
                    <div id="sidebar-actions" class="space-y-3">
                         <input type="file" id="add-files-input" multiple accept="image/*" class="hidden">
                         <label for="add-files-input" class="cursor-pointer w-full text-center block bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-3 rounded-lg transition-all">
                             사진 추가하기
                         </label>
                         <button id="reset-album-button" class="w-full text-center block bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-3 rounded-lg transition-all">
                             새로 시작하기
                         </button>
                    </div>
                </div>
            </aside>

            <main class="flex-grow flex flex-col relative transition-all duration-500 w-full overflow-y-auto custom-scrollbar" id="main-content">
                
                <!-- Upload Section -->
                <div id="upload-section" class="w-full h-full flex flex-col items-center justify-center text-white" style="background-image: url('https://images.unsplash.com/photo-1528543606781-2f6e6857f318?q=80&w=1965&auto=format&fit=crop'); background-size: cover; background-position: center;">
                    <div id="drag-area" class="relative z-10 text-center bg-black/20 backdrop-blur-sm rounded-2xl p-8 sm:p-12 transition-all duration-300 border border-white/30 hover:border-white/60 w-11/12 max-w-2xl">
                        <div class="flex flex-col items-center space-y-4">
                             <svg class="w-16 h-16 sm:w-20 sm:h-20 text-white opacity-80" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                            </svg>
                            <h2 class="text-2xl sm:text-3xl font-bold text-white">흩어진 여행의 조각들을, 하나의 추억으로</h2>
                            <p class="text-lg text-white/90">이곳을 클릭하거나 사진을 끌어다 놓으세요</p>
                            <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                            <label for="file-input" class="cursor-pointer absolute inset-0"></label>
                            <p class="text-sm text-white/70 pt-4">최대 60장의 이미지를 업로드할 수 있습니다.</p>
                        </div>
                    </div>
                </div>

                <!-- This wrapper will contain progress and gallery -->
                <div id="content-wrapper" class="hidden w-full h-full p-4 sm:p-8">
                    <!-- Progress Section -->
                    <div id="progress-section" class="hidden w-full max-w-lg mx-auto text-center my-auto">
                        <div class="flex items-center justify-center space-x-3 mb-4">
                             <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12"></div>
                             <h2 class="text-xl sm:text-2xl font-semibold text-slate-700">AI가 사진을 분석하고 있습니다...</h2>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-4 my-4 overflow-hidden">
                            <div id="progress-bar" class="bg-sky-400 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-slate-500">사진의 날짜와 내용을 분석하는 중입니다.</p>
                    </div>

                    <!-- Results Section (Gallery) -->
                    <div id="results-section" class="hidden w-full h-full">
                         <div id="gallery" class="w-full">
                             <!-- Dynamic content will be inserted here -->
                         </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal for notifications -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-sm w-full text-center transform transition-all" id="modal-content">
            <p id="notification-message" class="text-lg text-slate-700 mb-6"></p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <button id="notification-confirm" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">확인</button>
                <button id="notification-cancel" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-6 rounded-lg transition-colors">취소</button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const dragArea = document.getElementById('drag-area');
        const fileInput = document.getElementById('file-input');
        const addFilesInput = document.getElementById('add-files-input');
        const uploadSection = document.getElementById('upload-section');
        const progressSection = document.getElementById('progress-section');
        const resultsSection = document.getElementById('results-section');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const exportButton = document.getElementById('export-button');
        const gallery = document.getElementById('gallery');
        const categoryNav = document.getElementById('category-nav');
        const dateNav = document.getElementById('date-nav');
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const modalContent = document.getElementById('modal-content');
        const notificationConfirm = document.getElementById('notification-confirm');
        const notificationCancel = document.getElementById('notification-cancel');
        const menuToggleButton = document.getElementById('menu-toggle-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const resetAlbumButton = document.getElementById('reset-album-button');
        const filterResetButton = document.getElementById('filter-reset-button');
        const contentWrapper = document.getElementById('content-wrapper');

        const MAX_FILES = 60;
        let uploadedPhotos = [];
        let activeCategoryFilter = null;
        let activeDateFilter = null;

        // --- IndexedDB Helper ---
        const db = {
            _db: null,
            init: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('TravelAlbumDB', 1);
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('photos')) {
                            db.createObjectStore('photos', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = event => {
                        this._db = event.target.result;
                        resolve();
                    };
                    request.onerror = event => {
                        console.error('IndexedDB error:', event.target.errorCode);
                        reject(event.target.errorCode);
                    };
                });
            },
            savePhotos: function(photos) {
                return new Promise((resolve, reject) => {
                    if (!this._db) return reject('DB not initialized');
                    const transaction = this._db.transaction(['photos'], 'readwrite');
                    const store = transaction.objectStore('photos');
                    const clearRequest = store.clear();
                    clearRequest.onsuccess = () => {
                        if (photos.length === 0) { resolve(); return; }
                        let count = 0;
                        photos.forEach(photo => {
                            const addRequest = store.add(photo);
                            addRequest.onsuccess = () => {
                                count++;
                                if (count === photos.length) resolve();
                            };
                            addRequest.onerror = (event) => reject(event.target.error);
                        });
                    };
                    clearRequest.onerror = (event) => reject(event.target.error);
                });
            },
            getPhotos: function() {
                return new Promise((resolve, reject) => {
                    if (!this._db) return reject('DB not initialized');
                    const transaction = this._db.transaction(['photos'], 'readonly');
                    const store = transaction.objectStore('photos');
                    const request = store.getAll();
                    request.onsuccess = event => resolve(event.target.result);
                    request.onerror = event => reject(event.target.error);
                });
            },
            clearPhotos: function() {
                return new Promise((resolve, reject) => {
                    if (!this._db) return reject('DB not initialized');
                    const transaction = this._db.transaction(['photos'], 'readwrite');
                    const store = transaction.objectStore('photos');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }
        };


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
             try {
                await db.init();
                const savedPhotos = await db.getPhotos();
                if (Array.isArray(savedPhotos) && savedPhotos.length > 0) {
                    uploadedPhotos = savedPhotos;
                    uploadSection.classList.add('hidden');
                    contentWrapper.classList.remove('hidden');
                    displayResults();
                }
            } catch(e) {
                console.error("Failed to load photos from DB:", e);
                showNotification("저장된 앨범을 불러오는 데 실패했습니다.");
            }
        });

        // --- Mobile Sidebar Logic ---
        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }
        menuToggleButton.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        // --- Modal/Notification Functions ---
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationConfirm.textContent = '확인';
            notificationConfirm.onclick = hideNotification;
            notificationCancel.classList.add('hidden');
            notificationModal.classList.remove('hidden');
            modalContent.classList.remove('opacity-0', 'scale-95');
        }
        
        function showConfirmation(message, onConfirm) {
            notificationMessage.textContent = message;
            notificationConfirm.textContent = '확인';
            notificationCancel.classList.remove('hidden');
            notificationConfirm.onclick = () => {
                hideNotification();
                onConfirm();
            };
            notificationCancel.onclick = hideNotification;
            notificationModal.classList.remove('hidden');
            modalContent.classList.remove('opacity-0', 'scale-95');
        }

        function hideNotification() {
             modalContent.classList.add('opacity-0', 'scale-95');
             setTimeout(() => {
                notificationModal.classList.add('hidden');
             }, 300);
        }
        
        notificationModal.addEventListener('click', (e) => {
            if (e.target === notificationModal) hideNotification();
        });
        
        // --- File Handling & Drag n Drop ---
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            dragArea.addEventListener(eventName, e => e.preventDefault());
        });
        dragArea.addEventListener('dragover', () => dragArea.classList.add('drag-area-highlight'));
        dragArea.addEventListener('dragleave', () => dragArea.classList.remove('drag-area-highlight'));
        dragArea.addEventListener('drop', (e) => {
            dragArea.classList.remove('drag-area-highlight');
            handleFiles(Array.from(e.dataTransfer.files), false);
        });
        fileInput.addEventListener('change', (e) => handleFiles(Array.from(e.target.files), false));
        addFilesInput.addEventListener('change', (e) => handleFiles(Array.from(e.target.files), true));

        async function handleFiles(files, isAdding) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            if (imageFiles.length === 0) {
                showNotification('이미지 파일만 업로드할 수 있습니다.');
                return;
            }

            const currentCount = isAdding ? uploadedPhotos.length : 0;
            if (currentCount + imageFiles.length > MAX_FILES) {
                showNotification(`총 사진 개수가 ${MAX_FILES}장을 초과할 수 없습니다. (현재: ${currentCount}장)`);
                return;
            }

            if (!isAdding) {
                uploadedPhotos = [];
                activeCategoryFilter = null;
                activeDateFilter = null;
            }

            // Pre-read files to check for duplicates
            const readFileAsDataURL = (file) => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve({ file, src: e.target.result });
                    reader.readAsDataURL(file);
                });
            };

            const fileReadPromises = imageFiles.map(readFileAsDataURL);
            const readFiles = await Promise.all(fileReadPromises);

            const existingSrcs = new Set(uploadedPhotos.map(p => p.src));
            const newUniqueFiles = [];
            let duplicateFileCount = 0;

            readFiles.forEach(({ file, src }) => {
                if (existingSrcs.has(src)) {
                    duplicateFileCount++;
                } else {
                    newUniqueFiles.push(file);
                    existingSrcs.add(src); // Also check against newly added files
                }
            });

            if (duplicateFileCount > 0) {
                if (newUniqueFiles.length > 0) {
                    const message = `${duplicateFileCount}개의 중복된 사진을 제외하고, ${newUniqueFiles.length}개의 새로운 사진을 추가하시겠습니까?`;
                    showConfirmation(message, () => {
                        startAnalysis(newUniqueFiles);
                    });
                } else {
                    showNotification(`${duplicateFileCount}개의 사진이 모두 중복되어 추가할 사진이 없습니다.`);
                }
            } else {
                if (newUniqueFiles.length > 0) {
                    startAnalysis(newUniqueFiles);
                }
            }
        }


        // --- Main Analysis Logic ---
        async function startAnalysis(files) {
            if (files.length === 0) return;

            uploadSection.classList.add('hidden');
            contentWrapper.classList.remove('hidden');
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');

            sidebar.classList.add('hidden');
            menuToggleButton.classList.add('hidden');
            exportButton.classList.add('hidden');

            let completed = 0;
            const total = files.length;
            
            const newlyAnalyzedPhotos = [];

            const analysisPromises = files.map((file, index) => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const imageSrc = e.target.result;
                        const analysisResult = await getPhotoMetadata(file, imageSrc);

                        newlyAnalyzedPhotos.push({
                            id: `photo-${Date.now()}-${index}`,
                            name: file.name,
                            src: imageSrc,
                            ...analysisResult
                        });

                        completed++;
                        const progress = Math.round((completed / total) * 100);
                        
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `AI 분석 진행 중... (${completed}/${total})`;
                        
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            });

            await Promise.all(analysisPromises);
            
            uploadedPhotos = uploadedPhotos.concat(newlyAnalyzedPhotos);
            
            progressText.textContent = "분석 완료! 앨범을 생성합니다.";
            
            setTimeout(displayResults, 1000);
        }
        
        // --- Gemini AI Analysis ---
        async function analyzeImageWithGemini(imageSrc, mimeType) {
            const apiKey = ""; // This will be handled by the execution environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const base64Data = imageSrc.split(',')[1];

            const prompt = `이 여행 사진을 분석해서 다음 JSON 형식으로 응답해줘: {"category": "카테고리명", "caption": "15자 이내의 짧은 한글 캡션", "tags": ["#한글태그1", "#한글태그2"], "location": "도시/지역 이름"}. 카테고리는 '음식', '풍경', '인물', '건축물', '야경', '기타' 중에서 가장 적절한 것 하나만 선택해줘. location은 사진이 찍힌 도시나 관광지 이름으로 부탁해 (예: "서울", "제주", "부산"). 만약 특정 지역을 알 수 없거나 "실내", "집안" 같은 일반적인 장소라면 "미상"으로 응답해줘.`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }],
                 generationConfig: {
                    responseMimeType: "application/json",
                 }
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            return JSON.parse(text);
        }


        async function getPhotoMetadata(file, imageSrc) {
            const getDate = () => new Promise(resolve => {
                EXIF.getData(file, function() {
                    const exifDateStr = EXIF.getTag(this, "DateTimeOriginal");
                    if (exifDateStr) {
                        resolve(exifDateStr.split(" ")[0].replace(/:/g, "-"));
                    } else {
                        const d = new Date(file.lastModified);
                        resolve(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
                    }
                });
            });

            const date = await getDate();

            try {
                const analysis = await analyzeImageWithGemini(imageSrc, file.type);
                const locationBlocklist = ['실내', '집안', '미상'];
                if (!analysis.location || locationBlocklist.includes(analysis.location)) {
                    analysis.location = '장소 미확인';
                }
                return { ...analysis, date };
            } catch (error) {
                console.error("Gemini analysis failed for", file.name, error);
                // Fallback to a default if AI analysis fails
                return {
                    category: '기타',
                    caption: '여행의 특별한 기록',
                    tags: ['#여행'],
                    location: '장소 미확인',
                    date: date
                };
            }
        }


        // --- UI Display and Interaction ---
        function displayResults() {
            if (uploadedPhotos.length > 0) {
                uploadSection.classList.add('hidden');
                contentWrapper.classList.remove('hidden');
                progressSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                exportButton.classList.remove('hidden');
                sidebar.classList.remove('hidden');
                sidebar.classList.add('md:flex');
                menuToggleButton.classList.remove('hidden');
            } else {
                sidebar.classList.add('hidden');
                menuToggleButton.classList.add('hidden');
                exportButton.classList.add('hidden');
                contentWrapper.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                return;
            }
            
            const allCategories = ['음식', '풍경', '인물', '건축물', '야경', '기타'].filter(c => uploadedPhotos.some(p => p.category === c));
            categoryNav.innerHTML = allCategories.map(c => `<a href="#" data-category="${c}" class="block px-4 py-2 text-slate-600 font-medium rounded-md hover:bg-sky-100 hover:text-sky-600 transition-colors">${c}</a>`).join('');

            const allDates = [...new Set(uploadedPhotos.map(p => p.date))].sort();
            
            const getLocationForDate = (date) => {
                const photosOnDate = uploadedPhotos.filter(p => p.date === date);
                if (!photosOnDate.length) return null;

                const locationCounts = photosOnDate.reduce((acc, photo) => {
                    const loc = photo.location || '장소 미확인';
                    acc[loc] = (acc[loc] || 0) + 1;
                    return acc;
                }, {});

                const topLocation = Object.keys(locationCounts).reduce((a, b) => locationCounts[a] > locationCounts[b] ? a : b);
                return topLocation !== '장소 미확인' ? topLocation : null;
            };

            dateNav.innerHTML = allDates.map(date => {
                const location = getLocationForDate(date);
                const title = location ? `${date} (${location})` : date;
                return `<a href="#" data-date="${date}" class="block px-4 py-2 text-slate-600 font-medium rounded-md hover:bg-sky-100 hover:text-sky-600 transition-colors">${title}</a>`;
            }).join('');
            
            const sortedPhotos = uploadedPhotos.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            gallery.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
                    ${sortedPhotos.map(p => createPhotoCardHTML(p, allCategories)).join('')}
                </div>`;

            addCardEventListeners();
            applyFilters();
            savePhotosToDB();
        }
        
        function createPhotoCardHTML(photo, allCategories) {
            const displayTags = [...photo.tags, `#${photo.date}`];
            return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-all duration-300 group" data-id="${photo.id}" data-category="${photo.category}" data-date="${photo.date}">
                    <div class="relative">
                        <img src="${photo.src}" alt="${photo.caption}" class="w-full h-48 object-cover">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300"></div>
                        <button data-delete-id="${photo.id}" class="absolute top-2 right-2 p-1.5 bg-black bg-opacity-40 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity focus:outline-none hover:bg-opacity-60 z-10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 space-y-3">
                        <input type="text" value="${photo.caption}" data-field="caption" class="w-full border-b-2 border-slate-200 focus:border-sky-400 outline-none text-md font-semibold p-1" placeholder="캡션 수정...">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-slate-500">분류:</span>
                            <select data-field="category" class="text-sm bg-slate-100 border-none rounded-md px-2 py-1 focus:ring-2 focus:ring-sky-300 outline-none">
                                ${allCategories.map(cat => `<option value="${cat}" ${cat === photo.category ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex flex-wrap gap-2 text-xs">
                            ${displayTags.map(tag => `<span class="bg-slate-200 text-slate-600 px-2 py-1 rounded-full">${tag}</span>`).join('')}
                        </div>
                    </div>
                </div>`;
        }
        
        function addCardEventListeners() {
            gallery.querySelectorAll('.group').forEach(card => {
                card.querySelector('input[data-field="caption"]').addEventListener('change', (e) => updatePhotoData(card.dataset.id, 'caption', e.target.value));
                card.querySelector('select[data-field="category"]').addEventListener('change', (e) => {
                    const newCategory = e.target.value;
                    updatePhotoData(card.dataset.id, 'category', newCategory);
                    card.dataset.category = newCategory;
                });
                 card.querySelector('[data-delete-id]').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const photoId = e.currentTarget.dataset.deleteId;
                    showConfirmation('이 사진을 앨범에서 삭제하시겠습니까?', () => {
                        uploadedPhotos = uploadedPhotos.filter(p => p.id !== photoId);
                        savePhotosToDB().then(() => {
                            displayResults();
                        });
                    });
                });
            });
        }
        
        function updatePhotoData(photoId, field, value) {
            const photo = uploadedPhotos.find(p => p.id === photoId);
            if (photo) {
                photo[field] = value;
                savePhotosToDB();
            }
        }
        
        function handleNavClick(e) {
            e.preventDefault();
            const link = e.target.closest('a');
            if (!link) return;
            
            if (window.innerWidth < 768) { // md breakpoint
                toggleSidebar();
            }

            const category = link.dataset.category;
            const date = link.dataset.date;

            if (category) {
                 toggleCategoryFilter(category, link);
            } else if (date) {
                 toggleDateFilter(date, link);
            }
        }
        
        categoryNav.addEventListener('click', handleNavClick);
        dateNav.addEventListener('click', handleNavClick);
        
        resetAlbumButton.addEventListener('click', () => {
             showConfirmation("정말로 현재 앨범을 지우고 새로 시작하시겠습니까?", async () => {
                try {
                    await db.clearPhotos();
                    window.location.reload();
                } catch(e) {
                    console.error("Failed to clear DB:", e);
                    showNotification("앨범을 초기화하는 데 실패했습니다.");
                }
            });
        });

        filterResetButton.addEventListener('click', (e) => {
            e.preventDefault();
            activeCategoryFilter = null;
            activeDateFilter = null;
            
            dateNav.querySelectorAll('a').forEach(a => a.classList.remove('bg-sky-100', 'text-sky-600'));
            categoryNav.querySelectorAll('a').forEach(a => a.classList.remove('bg-sky-100', 'text-sky-600'));

            applyFilters();
        });

        function toggleCategoryFilter(category, link) {
            if (activeCategoryFilter === category) {
                activeCategoryFilter = null; // Untoggle
            } else {
                activeCategoryFilter = category;
            }
            // Update UI
            categoryNav.querySelectorAll('a').forEach(a => a.classList.remove('bg-sky-100', 'text-sky-600'));
            if(activeCategoryFilter){
                link.classList.add('bg-sky-100', 'text-sky-600');
            }
            applyFilters();
        }

        function toggleDateFilter(date, link) {
            if (activeDateFilter === date) {
                activeDateFilter = null; // Untoggle
            } else {
                activeDateFilter = date;
            }
            // Update UI
            dateNav.querySelectorAll('a').forEach(a => a.classList.remove('bg-sky-100', 'text-sky-600'));
            if(activeDateFilter){
                link.classList.add('bg-sky-100', 'text-sky-600');
            }
            applyFilters();
        }

        function applyFilters() {
            gallery.querySelectorAll('.group').forEach(card => {
                const categoryMatch = !activeCategoryFilter || card.dataset.category === activeCategoryFilter;
                const dateMatch = !activeDateFilter || card.dataset.date === activeDateFilter;

                if (categoryMatch && dateMatch) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });

            if (activeCategoryFilter || activeDateFilter) {
                filterResetButton.classList.remove('hidden');
            } else {
                filterResetButton.classList.add('hidden');
            }
        }


        // --- Data Persistence ---
        async function savePhotosToDB() {
            try {
                await db.savePhotos(uploadedPhotos);
            } catch (e) {
                console.error("Failed to save photos to DB:", e);
                showNotification("앨범을 저장하는 데 실패했습니다. 브라우저 저장 공간이 부족할 수 있습니다.");
            }
        }

        // --- Export Logic ---
        exportButton.addEventListener('click', () => {
             const albumHTML = generateAlbumHTML();
             const blob = new Blob([albumHTML], { type: 'text/html' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = 'my-travel-album.html';
             a.click();
             URL.revokeObjectURL(url);
        });

        function generateAlbumHTML() {
            const bodyContent = `
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    ${uploadedPhotos.sort((a,b) => new Date(a.date) - new Date(b.date)).map(photo => {
                        const displayTags = [...photo.tags, `#${photo.date}`];
                        return `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden">
                            <img src="${photo.src}" alt="${photo.caption}" class="w-full h-56 object-cover">
                            <div class="p-4">
                                <p class="font-semibold text-gray-700">${photo.caption}</p>
                                <div class="mt-2 flex flex-wrap gap-2 text-xs">
                                     <span class="bg-sky-100 text-sky-700 px-2 py-1 rounded-full">${photo.category}</span>
                                     ${displayTags.map(tag => `<span class="bg-gray-200 text-gray-600 px-2 py-1 rounded-full">${tag}</span>`).join('')}
                                </div>
                            </div>
                        </div>`;
                        }).join('')}
                </div>`;

            return `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>나의 여행 앨범</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
                    <style> body { font-family: 'Noto Sans KR', sans-serif; } </style>
                </head>
                <body class="bg-gray-100">
                    <div class="container mx-auto p-4 sm:p-8">
                        <header class="text-center mb-12">
                            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800">나의 특별한 여행 앨범</h1>
                            <p class="text-gray-500 mt-2">Gemini AI와 함께 만든 추억의 기록</p>
                        </header>
                        <main>${bodyContent}</main>
                        <footer class="text-center mt-12 py-6 border-t">
                             <p class="text-gray-500">Generated by Gemini AI Travel Album Maker</p>
                        </footer>
                    </div>
                </body>
                </html>`;
        }
    </script>
</body>
</html>

